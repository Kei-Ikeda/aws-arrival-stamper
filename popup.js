// üõÇ AWS Arrival Stamper - Popup Script
class SettingsManager {
  constructor() {
    this.settings = {
      isEnabled: true,
      regionColors: true,
      stampStyle: "classic",
      accountColors: {},
    };

    this.elements = {
      enableToggle: document.getElementById("enableToggle"),
      regionColorsToggle: document.getElementById("regionColorsToggle"),
      stampStyle: document.getElementById("stampStyle"),
      status: document.getElementById("status"),
      resetBtn: document.getElementById("resetBtn"),
      // „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆöÈñ¢ÈÄ£
      accountId: document.getElementById("accountId"),
      accountEnvironment: document.getElementById("accountEnvironment"),
      accountColor: document.getElementById("accountColor"),
      accountName: document.getElementById("accountName"),
      saveAccountBtn: document.getElementById("saveAccountBtn"),
      deleteAccountBtn: document.getElementById("deleteAccountBtn"),
      accountList: document.getElementById("accountList"),
    };
    
    this.selectedAccountId = null;
    this.lastSaveTime = 0;
    this.saveRateLimit = 1000; // 1ÁßíÈñì„Å´1Âõû„ÅÆ‰øùÂ≠òÂà∂Èôê

    this.init();
  }

  async init() {
    await this.loadSettings();
    this.bindEvents();
    this.updateUI();
    this.updateStatus();
    this.updateAccountList();
  }

  async loadSettings() {
    try {
      const stored = await chrome.storage.sync.get([
        "isEnabled",
        "regionColors",
        "stampStyle",
        "accountColors",
      ]);

      this.settings = {
        isEnabled: stored.isEnabled !== false,
        regionColors: stored.regionColors !== false,
        stampStyle: stored.stampStyle || "classic",
        accountColors: stored.accountColors || {},
      };
    } catch (error) {
      console.warn("Failed to load settings:", error);
    }
  }

  async saveSettings() {
    try {
      await chrome.storage.sync.set(this.settings);
      this.updateStatus();

      // Content script„Å´Ë®≠ÂÆöÂ§âÊõ¥„ÇíÈÄöÁü•
      this.notifyContentScript();
    } catch (error) {
      console.error("Failed to save settings:", error);
    }
  }

  async notifyContentScript() {
    try {
      const [tab] = await chrome.tabs.query({
        active: true,
        currentWindow: true,
      });
      if (
        tab &&
        tab.url &&
        (tab.url.includes("console.aws.amazon.com") ||
          tab.url.includes("awsapps.com"))
      ) {
        chrome.tabs
          .sendMessage(tab.id, {
            type: "SETTINGS_UPDATED",
            settings: this.settings,
          })
          .catch(() => {
            // Content script might not be ready, that's ok
          });
      }
    } catch (error) {
      // „Çø„Éñ„Ç¢„ÇØ„Çª„ÇπÂ§±Êïó„ÅØÁÑ°Ë¶ñ
    }
  }

  bindEvents() {
    // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆ„Ç™„É≥/„Ç™„Éï
    this.elements.enableToggle.addEventListener("click", () => {
      this.settings.isEnabled = !this.settings.isEnabled;
      this.updateToggle(this.elements.enableToggle, this.settings.isEnabled);
      this.saveSettings();
    });

    // „É™„Éº„Ç∏„Éß„É≥„Ç´„É©„Éº„ÅÆ„Ç™„É≥/„Ç™„Éï
    this.elements.regionColorsToggle.addEventListener("click", () => {
      this.settings.regionColors = !this.settings.regionColors;
      this.updateToggle(
        this.elements.regionColorsToggle,
        this.settings.regionColors
      );
      this.saveSettings();
    });

    // „Çπ„Çø„É≥„Éó„Çπ„Çø„Ç§„É´Â§âÊõ¥
    this.elements.stampStyle.addEventListener("change", (e) => {
      this.settings.stampStyle = e.target.value;
      this.updatePreviewStyle();
      this.saveSettings();
    });

    // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
    this.elements.resetBtn.addEventListener("click", () => {
      this.resetSettings();
    });

    // „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆöÈñ¢ÈÄ£
    this.elements.saveAccountBtn.addEventListener("click", () => {
      this.saveAccountSettings();
    });

    this.elements.deleteAccountBtn.addEventListener("click", () => {
      this.deleteAccountSettings();
    });

    this.elements.accountId.addEventListener("input", () => {
      this.validateAccountForm();
    });

    this.elements.accountId.addEventListener("blur", () => {
      this.loadAccountSettings();
    });
  }

  updateUI() {
    // „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    this.updateToggle(this.elements.enableToggle, this.settings.isEnabled);
    this.updateToggle(
      this.elements.regionColorsToggle,
      this.settings.regionColors
    );

    // „Çπ„Çø„Ç§„É´ÈÅ∏Êäû„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    this.elements.stampStyle.value = this.settings.stampStyle;

    // „Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
    this.updatePreviewStyle();
  }

  updateToggle(toggleElement, isActive) {
    if (isActive) {
      toggleElement.classList.add("active");
    } else {
      toggleElement.classList.remove("active");
    }
  }

  updatePreviewStyle() {
    const previews = document.querySelectorAll(".preview-stamp");
    const style = this.settings.stampStyle;

    previews.forEach((preview) => {
      // Êó¢Â≠ò„ÅÆ„Çπ„Çø„Ç§„É´„ÇØ„É©„Çπ„ÇíÂâäÈô§
      preview.classList.remove("classic", "vintage", "modern", "cute");
      // Êñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´„ÇØ„É©„Çπ„ÇíËøΩÂä†
      preview.classList.add(style);
      
      // ‰∏çË¶Å„Å´„Å™„Å£„Åü„Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
      preview.removeAttribute('style');
    });
  }

  updateStatus() {
    const status = this.elements.status;

    if (this.settings.isEnabled) {
      status.textContent = "‚úÖ „Çπ„Çø„É≥„Éó„Çµ„Éº„Éì„ÇπÊúâÂäπ";
      status.className = "status active";
    } else {
      status.textContent = "‚ùå „Çπ„Çø„É≥„Éó„Çµ„Éº„Éì„ÇπÁÑ°Âäπ";
      status.className = "status inactive";
    }
  }

  async resetSettings() {
    if (confirm("Ë®≠ÂÆö„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü")) {
      this.settings = {
        isEnabled: true,
        regionColors: true,
        stampStyle: "classic",
        accountColors: {},
      };

      await this.saveSettings();
      this.updateUI();
      this.updateAccountList();
      this.clearAccountForm();

      // „É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ - „ÇØ„É©„Çπ„Éô„Éº„Çπ
      const originalText = this.elements.resetBtn.textContent;
      this.elements.resetBtn.textContent = "‚úÖ „É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü";
      this.elements.resetBtn.classList.add("success");

      setTimeout(() => {
        this.elements.resetBtn.textContent = originalText;
        this.elements.resetBtn.classList.remove("success");
      }, 1500);
    }
  }

  // „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆöÁÆ°ÁêÜ„É°„ÇΩ„ÉÉ„Éâ
  saveAccountSettings() {
    // „É¨„Éº„ÉàÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
    if (!this.checkRateLimit()) {
      this.showError("Ë®≠ÂÆöÂ§âÊõ¥„ÅåÈ†ªÁπÅ„Åô„Åé„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }

    const accountId = this.sanitizeAccountId(this.elements.accountId.value);
    const environment = this.elements.accountEnvironment.value;
    const color = this.elements.accountColor.value;
    const name = this.sanitizeName(this.elements.accountName.value);

    // Âº∑Âåñ„Åï„Çå„ÅüÂÖ•ÂäõÂÄ§Ê§úË®º
    if (!this.isValidAccountId(accountId)) {
      this.showError("ÊúâÂäπ„Å™AWS„Ç¢„Ç´„Ç¶„É≥„ÉàID (12Ê°Å„ÅÆÊï∞Â≠ó) „ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }

    if (!this.isValidEnvironment(environment)) {
      this.showError("ÁÑ°Âäπ„Å™Áí∞Â¢É„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô");
      return;
    }

    if (!this.isValidName(name)) {
      this.showError("Ë°®Á§∫Âêç„Å´ÁÑ°Âäπ„Å™ÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅ50ÊñáÂ≠ó„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô");
      return;
    }

    // ËøΩÂä†„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ
    if (name && name.length > 0) {
      const sanitizedName = this.sanitizeName(name);
      if (sanitizedName !== name) {
        this.showError("Ë°®Á§∫Âêç„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô");
        return;
      }
    }

    const accountConfig = {
      environment: environment || null,
      color: this.sanitizeColor(color),
      name: name || null,
    };

    this.settings.accountColors[accountId] = accountConfig;
    this.saveSettings();
    this.updateAccountList();
    this.showSaveSuccess();
  }

  showError(message) {
    // „Çª„Ç≠„É•„Ç¢„Å™„Ç®„É©„ÉºË°®Á§∫ - „ÇØ„É©„Çπ„Éô„Éº„Çπ
    const errorElement = document.createElement('div');
    errorElement.className = 'error-message';
    errorElement.textContent = message;
    
    document.body.appendChild(errorElement);
    
    setTimeout(() => {
      if (document.body.contains(errorElement)) {
        document.body.removeChild(errorElement);
      }
    }, 3000);
  }

  deleteAccountSettings() {
    if (!this.selectedAccountId) return;
    
    if (confirm(`„Ç¢„Ç´„Ç¶„É≥„Éà ${this.selectedAccountId} „ÅÆË®≠ÂÆö„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
      delete this.settings.accountColors[this.selectedAccountId];
      this.saveSettings();
      this.updateAccountList();
      this.clearAccountForm();
    }
  }

  loadAccountSettings() {
    const accountId = this.elements.accountId.value.trim();
    if (!this.isValidAccountId(accountId)) {
      this.clearAccountForm(false);
      return;
    }

    const config = this.settings.accountColors[accountId];
    if (config) {
      this.elements.accountEnvironment.value = config.environment || "";
      this.elements.accountColor.value = config.color || "#3b82f6";
      this.elements.accountName.value = config.name || "";
      this.selectedAccountId = accountId;
      this.elements.deleteAccountBtn.disabled = false;
    } else {
      this.elements.accountEnvironment.value = "";
      this.elements.accountColor.value = "#3b82f6";
      this.elements.accountName.value = "";
      this.selectedAccountId = null;
      this.elements.deleteAccountBtn.disabled = true;
    }
  }

  clearAccountForm(clearId = true) {
    if (clearId) {
      this.elements.accountId.value = "";
    }
    this.elements.accountEnvironment.value = "";
    this.elements.accountColor.value = "#3b82f6";
    this.elements.accountName.value = "";
    this.selectedAccountId = null;
    this.elements.deleteAccountBtn.disabled = true;
  }

  validateAccountForm() {
    const accountId = this.elements.accountId.value.trim();
    this.elements.saveAccountBtn.disabled = !this.isValidAccountId(accountId);
  }

  isValidAccountId(accountId) {
    return /^\d{12}$/.test(accountId);
  }

  updateAccountList() {
    const accountList = this.elements.accountList;
    accountList.innerHTML = "";

    const accounts = Object.keys(this.settings.accountColors);
    if (accounts.length === 0) {
      const emptyMessage = document.createElement("p");
      emptyMessage.className = "empty-message";
      emptyMessage.textContent = "Ë®≠ÂÆö„Åï„Çå„Åü„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì";
      accountList.appendChild(emptyMessage);
      return;
    }

    accounts.forEach(accountId => {
      const config = this.settings.accountColors[accountId];
      const item = document.createElement("div");
      item.className = "account-list-item";
      
      // „Çª„Ç≠„É•„Ç¢„Å™DOMÊßãÁØâ - „ÇØ„É©„Çπ„Éô„Éº„Çπ
      const textContainer = document.createElement("div");
      textContainer.className = "account-info";
      
      const accountSpan = document.createElement("span");
      accountSpan.className = "account-id";
      accountSpan.textContent = this.sanitizeInput(accountId);
      
      const nameSpan = document.createElement("span");
      nameSpan.className = "account-name";
      if (config.name) {
        nameSpan.textContent = ` (${this.sanitizeInput(config.name)})`;
      }
      
      const lineBreak = document.createElement("br");
      
      const envSpan = document.createElement("span");
      envSpan.className = "account-env";
      const envText = config.environment ? config.environment.toUpperCase() : "AUTO";
      envSpan.textContent = this.sanitizeInput(envText);
      
      textContainer.appendChild(accountSpan);
      textContainer.appendChild(nameSpan);
      textContainer.appendChild(lineBreak);
      textContainer.appendChild(envSpan);
      
      const colorBox = document.createElement("div");
      colorBox.className = "account-color-box";
      colorBox.style.backgroundColor = this.sanitizeColor(config.color);
      
      item.appendChild(textContainer);
      item.appendChild(colorBox);
      
      item.addEventListener("click", () => {
        this.elements.accountId.value = accountId;
        this.loadAccountSettings();
      });
      
      accountList.appendChild(item);
    });
  }

  // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ„Åï„Çå„ÅüÂÖ•ÂäõÂÄ§Ê§úË®º„É°„ÇΩ„ÉÉ„Éâ
  sanitizeInput(input) {
    if (typeof input !== 'string') return '';
    
    // HTML„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„Ç®„Çπ„Ç±„Éº„Éó
    const entityMap = {
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '&': '&amp;',
      '/': '&#x2F;',
      '\\': '&#x5C;'
    };
    
    return input
      .replace(/[<>"'&\/\\]/g, char => entityMap[char] || char)
      .trim()
      .substring(0, 100);
  }

  sanitizeAccountId(input) {
    if (typeof input !== 'string') return '';
    // „Ç¢„Ç´„Ç¶„É≥„ÉàID„ÅØÊï∞Â≠ó„ÅÆ„ÅøË®±ÂèØ
    return input.replace(/[^\d]/g, '').substring(0, 12);
  }

  sanitizeName(input) {
    if (typeof input !== 'string') return '';
    
    // „Çà„ÇäÂé≥Ê†º„Å™ÂêçÂâç„ÅÆ„Çµ„Éã„Çø„Ç§„Çº„Éº„Ç∑„Éß„É≥
    const dangerousPatterns = [
      /<script/i, /javascript:/i, /vbscript:/i, /on\w+=/i,
      /expression\s*\(/i, /url\s*\(/i, /import\s/i
    ];
    
    // Âç±Èô∫„Éë„Çø„Éº„É≥„ÅÆÊ§úÂá∫
    if (dangerousPatterns.some(pattern => pattern.test(input))) {
      console.warn('Potentially dangerous input detected in name field');
      return '';
    }
    
    // ÂÆâÂÖ®„Å™ÊñáÂ≠ó„ÅÆ„ÅøË®±ÂèØÔºàËã±Êï∞Â≠ó„ÄÅ„Çπ„Éö„Éº„Çπ„ÄÅ„Éè„Ç§„Éï„É≥„ÄÅ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÄÅÊó•Êú¨Ë™ûÔºâ
    return input
      .replace(/[^\w\s\-\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '')
      .trim()
      .substring(0, 50);
  }

  sanitizeColor(color) {
    if (typeof color !== 'string') return '#3b82f6';
    
    // Âé≥ÂØÜ„Å™„Ç´„É©„Éº„Ç≥„Éº„ÉâÊ§úË®º
    const colorRegex = /^#[0-9A-Fa-f]{6}$/;
    if (!colorRegex.test(color)) {
      console.warn('Invalid color format detected:', color);
      return '#3b82f6';
    }
    
    // CSSÊ≥®ÂÖ•ÊîªÊíÉ„ÇíÈò≤„Åê„Åü„ÇÅ„ÅÆËøΩÂä†„ÉÅ„Çß„ÉÉ„ÇØ
    const dangerousKeywords = [
      'expression', 'javascript', 'vbscript', 'data:', 
      'url(', 'import', '@import', 'behavior'
    ];
    
    const lowerColor = color.toLowerCase();
    if (dangerousKeywords.some(keyword => lowerColor.includes(keyword))) {
      console.warn('Potentially dangerous color value detected:', color);
      return '#3b82f6';
    }
    
    return color;
  }

  isValidName(name) {
    if (typeof name !== 'string') return false;
    if (name.length === 0) return true; // Á©∫ÊñáÂ≠ó„ÅØË®±ÂèØ
    if (name.length > 50) return false;
    
    // Âç±Èô∫„Å™„Éë„Çø„Éº„É≥„ÅÆÊ§úË®º
    const dangerousPatterns = [
      /<[^>]*>/,  // HTML„Çø„Ç∞
      /javascript:/i,
      /vbscript:/i,
      /on\w+=/i,
      /expression\s*\(/i
    ];
    
    return !dangerousPatterns.some(pattern => pattern.test(name));
  }

  isValidEnvironment(env) {
    const validEnvs = ['', 'dev', 'staging', 'prod', 'test', 'sandbox'];
    return typeof env === 'string' && validEnvs.includes(env);
  }

  checkRateLimit() {
    const now = Date.now();
    if (now - this.lastSaveTime < this.saveRateLimit) {
      return false;
    }
    this.lastSaveTime = now;
    return true;
  }

  showSaveSuccess() {
    const originalText = this.elements.saveAccountBtn.textContent;
    this.elements.saveAccountBtn.textContent = "‚úÖ ‰øùÂ≠òÂÆå‰∫Ü";
    this.elements.saveAccountBtn.classList.add("success");
    
    setTimeout(() => {
      this.elements.saveAccountBtn.textContent = originalText;
      this.elements.saveAccountBtn.classList.remove("success");
    }, 1500);
  }
}

// „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
document.addEventListener("DOMContentLoaded", () => {
  new SettingsManager();
});

// ÁèæÂú®„ÅÆ„Çø„ÉñÊÉÖÂ†±„ÇíË°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
  const tab = tabs[0];
  if (tab && tab.url) {
    const isAWSPage =
      tab.url.includes("console.aws.amazon.com") ||
      tab.url.includes("awsapps.com");

    if (!isAWSPage) {
      const status = document.getElementById("status");
      status.textContent = "‚ÑπÔ∏è AWS„Éö„Éº„Ç∏„ÅßÊúâÂäπ„Å´„Å™„Çä„Åæ„Åô";
      status.className = "status aws-page-info";
    }
  }
});
